name: Auto Tag and Release pkg_auth

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      release_version:
        description: "Manually specify next release version (leave empty for auto)"
        required: false
        default: ""

concurrency:
  group: build-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  tag-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_tag: ${{ steps.bump_version.outputs.new_tag }}
      latest_tag: ${{ steps.bump_version.outputs.latest_tag }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build pkg_auth artifacts (sdist + wheel)
        working-directory: .
        run: |
          python -m pip install --upgrade pip
          pip install build
          python -m build
          

      - name: Configure Git User
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions"

      - name: Fetch All Tags
        run: git fetch --tags --force

      - name: Determine Next Release Version
        id: bump_version
        run: |
          branch_name="${GITHUB_REF#refs/heads/}"
          manual_version="${{ github.event.inputs.release_version }}"

          # Determine tag
          latest_tag=$(git tag --list --sort=-v:refname | head -n 1)
          latest_tag=${latest_tag:-0.0.0}
          latest_tag_alias="latest"

          if [[ -n "$manual_version" ]]; then
            # Use manually provided version directly
            new_tag="${manual_version}"
          else
            # Auto bump
            version=$(echo "$latest_tag")
            IFS='.' read -r -a parts <<< "$version"
            while true; do
              parts[2]=$((parts[2] + 1))
              new_version="${parts[0]}.${parts[1]}.${parts[2]}"
              new_tag="${new_version}"
              if ! git rev-parse "$new_tag" >/dev/null 2>&1; then
                break
              fi
            done
          fi

          echo "new_tag=$new_tag" >> $GITHUB_ENV
          echo "latest_tag=$latest_tag_alias" >> $GITHUB_ENV
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "latest_tag=$latest_tag_alias" >> $GITHUB_OUTPUT

      - name: Create and Push Git Tag
        run: |
          git tag -a ${{ env.new_tag }} ${{ github.sha }} -m "Release ${{ env.new_tag }}"
          git push origin ${{ env.new_tag }}

      - name: Create GitHub Release
        if: github.ref_name == 'main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.new_tag }}
          target_commitish: ${{ github.sha }}
          name: Release ${{ env.new_tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            Install directly from the tag:

            pip install "git+https://github.com/${{ github.repository }}.git@pkg_auth-v${{ inputs.version }}#subdirectory=packages/pkg_auth"

            Or from release assets (wheel/sdist) attached to this release.

          files: |
            src/pkg_auth/dist/*

